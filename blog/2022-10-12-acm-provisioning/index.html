<!doctype html><html><head><link rel=stylesheet href=https://docs.acksyn.org/sass/patternfly.css><link rel=stylesheet href=https://docs.acksyn.org/sass/patternfly-addons.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.7.2/css/solid.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.7.2/css/fontawesome.css><title>Multi-cluster GitOps with Provisioning | Hybrid Cloud Patterns test</title></head><body><div class=pf-c-page><header class=pf-c-page__header><div class=pf-c-page__header-brand><a href=/ class=pf-c-page__header-brand-link><img src=/images/hybrid_cloud_patterns.png alt="Hybrid Cloud Patterns test"></a></div><div class=pf-c-page__header-tools><nav class="pf-c-nav pf-m-horizontal" role=navigation><ul class=pf-c-nav__list><li class=pf-c-nav__item><a class=pf-c-nav__link href=/patterns/ title=Patterns>Get Patterns</a></li><li class=pf-c-nav__item><a class=pf-c-nav__link href=/learn/ title=Learn>Learn</a></li><li class=pf-c-nav__item><a class=pf-c-nav__link href=/contribute/ title=Contribute>Contribute</a></li><li class="pf-c-nav__item pf-m-current"><a class=pf-c-nav__link href=/blog/ title=Blog>Blog</a></li></ul></nav></div></header><div class=pf-c-page__sidebar><div class=pf-c-page__sidebar-body><div class=pf-c-nav><ul class=pf-c-nav__list><li class=pf-c-nav__item><a href=/blog/ class=pf-c-nav__link><span class="pf-c-icon pf-m-md pf-m-inline"><span class=pf-c-icon__content><i class="fas fa-arrow-left" aria-hidden=true></i></span></span>
<span style=padding-left:10px>Back to Blog</span></a></li></ul></div></div></div><main class=pf-c-page__main><section class=pf-c-page__main-section><div class="pf-l-grid pf-m-gutter"><div class="pf-l-grid__item pf-m-8-col"><div class=pf-c-content><h1>Multi-cluster GitOps with Provisioning</h1><div class=pf-c-content><p>October 12, 2022</p><span class="pf-c-label pf-m-orange"><span class=pf-c-label__content>acm</span></span>
<span class="pf-c-label pf-m-orange"><span class=pf-c-label__content>provisioning</span></span>
<span class="pf-c-label pf-m-orange"><span class=pf-c-label__content>patterns</span></span>
<span class="pf-c-label pf-m-orange"><span class=pf-c-label__content>GitOps</span></span><h1 id=multi-cluster-gitops-with-provisioning>Multi-cluster GitOps with Provisioning</h1><h2 id=introduction>Introduction</h2><p>Validated Patterns are an opinionated GitOps environment that lowers the bar for
those creating repeatable and declarative deployments. It’s value is most
apparent when delivering demos and solutions that span multiple areas of our
portfolio. Our skeleton allows folks to focus on what needs to be delivered
while we take care of how to do so using best practices. This is further
illustrated in the simplified way patterns use ACM to provision additional
clusters.</p><p>Not only do patterns allow a cluster to completely configure itself - including
elements traditionally handled with scripting and extending beyond the cluster,
but we can now also declaratively teach it about a set of clusters it should
provision and subsequently configure.</p><p>Let’s walk through an example using the Multi-Cloud GitOps pattern as an example…</p><h2 id=preparation>Preparation</h2><p>Start by <a href=https://hybrid-cloud-patterns.io/multicloud-gitops/getting-started/>deploying</a> the Multi-cloud GitOps pattern on AWS.</p><p>If you&rsquo;ve never deployed OpenShift before, you could try <a href=https://cloud.redhat.com/learn/getting-started-red-hat-openshift-service-aws-rosa/deploy-rosa-cluster>ROSA</a>
the pay-as-you-go OpenShift managed service.</p><p>Next, you&rsquo;ll need to create a fork of the
<a href=https://github.com/hybrid-cloud-gitops/multicloud-gitops/>https://github.com/hybrid-cloud-gitops/multicloud-gitops/</a> repo. Go there in a
browser, make sure you’re logged in to GitHub, click the “Fork” button, and
confirm the destination by clicking the big green &ldquo;Create fork&rdquo; button.</p><p>Now you have a copy of the pattern that you can make changes to. You can read
more about the Multi-cloud GitOps pattern on our <a href=https://hybrid-cloud-patterns.io/multicloud-gitops/>community
site</a></p><p>Next, <a href=%5Bhttps://hybrid-cloud-patterns.io/infrastructure/using-validated-pattern-operator/%5D(https://youtu.be/AHLam3u8eKM)>install the Validated Patterns operator</a> from Operator Hub.</p><p>And finally, click through to the installed operator, and select the <code>Create instance</code> button and fill out the Create a Pattern form. Most of the defaults
are fine, but make sure you update the GitSpec URL to point to your fork of
<code>multicloud-gitops</code>, rather than
<code>https://github.com/hybrid-cloud-patterns/multicloud-gitops</code>.</p><h3 id=providing-your-cloud-credentials>Providing your Cloud Credentials</h3><p>Secrets must never be stored in Git. Even in encrypted form, you likely also
publish metadata that may be exploited to launch spear phishing, and
waterholing attacks.</p><p>The Multi-Cloud GitOps pattern uses HashiCorp&rsquo;s Vault for secure secret
storage.</p><p>In order to provision additional clusters, the hub will need your cloud
credentials. To do this you can either manually load the secrets into the
vault via the UI, or make use of the following process for loading them from a
machine you control.</p><p>First clone your fork of the repository onto your local machine, and copy the template to a location not controlled by Git (to avoid accidentally committing the contents)</p><pre tabindex=0><code>git clone git@github.com:{yourfork}/multicloud-gitops.git
cp values-secret.yaml.template ~/values-secret.yaml
</code></pre><p>You will need to uncomment and provide values for the following keys in order to make use of the provisioning functionality:</p><pre tabindex=0><code>secrets:
  aws:                                       [1]
    access_key_id: AKIAIOSFODNN7EXAMPLE
    secret_access_key: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY

files:
  publickey: ~/.ssh/id_rsa.pub               [2]
  openshiftPullSecret: ~/.dockerconfigjson   [3]
</code></pre><p><em>[1]</em> A guide to finding the relevant AWS values can be found at
<a href=https://docs.aws.amazon.com/powershell/latest/userguide/pstools-appendix-sign-up.html>https://docs.aws.amazon.com/powershell/latest/userguide/pstools-appendix-sign-up.html</a>
You might even have them in a <code>~/.aws/credentials</code> file.</p><p><em>[2]</em> The public key is used to allow access to OpenShift nodes for triage purposes.</p><p><em>[3]</em> The openshiftPullSecret is how Red Hat knows you’ve got a licence to install
OpenShift. To obtain one, go to
<a href=https://console.redhat.com/openshift/install/pull-secret>https://console.redhat.com/openshift/install/pull-secret</a>, save the contents, and
provide that path in the secrets file. The contents should start with something
like: <code>{"auths":{"cloud.openshift.com":{"auth":"...</code>.</p><p>Obtain the login command for your cluster and run it locally.
<img src=/images/provision/console-login.png alt="console login"></p><p>Ensure <code>podman</code> is installed, and load the secrets with:</p><pre tabindex=0><code>./common/scripts/pattern-util.sh make load-secrets
</code></pre><p><a href=https://youtu.be/zagNOk21RPo><img src=https://img.youtube.com/vi/zagNOk21RPo/default.jpg alt="Loading provisioning secrets" title="Loading provisioning secrets"></a></p><p>These values will be used to create a number of secrets that ACM expects in
order to provision clusters.</p><h2 id=define-a-managed-cluster-group>Define a Managed Cluster Group</h2><p>Managed cluster groups are sets of clusters, grouped by function, that share a
common configuration set. There is no limitation on the number of groups, or
the number of clusters within each group, however IIUC there is a scaling limit
of approximately 1000 clusters in total.</p><p>The following is the example we will use today:</p><pre tabindex=0><code>  managedClusterGroups:
    myFirstGroup:
      name: group-one
      labels:
      - name: clusterGroup
        value: group-one
</code></pre><p><code>.name</code> is significant here and defines which site file (<code>values-{name}.yaml</code>) is
used as the cluster&rsquo;s bill-of-materials. In the example above, you would need
to make sure that <code>values-group-one.yaml</code> existed at the top of the Git repo and
contained a list of all the namespaces, subscriptions, and applications that
should be delivered to the cluster.</p><p><code>.labels</code> tells ACM how to decide which clusters get this site configuration. If
you were building and <a href=https://hybrid-cloud-patterns.io/industrial-edge/factory/>importing
clusters</a> yourself,
these are the labels you would need to specify during the import process. You
can specify different and/or additional labels, but the default is to use
<code>clusterGroup={name of the group}</code></p><h2 id=create-a-cluster-pool>Create a Cluster Pool</h2><p>Validated Patterns use cluster pools to automatically provision and configure
sets of spoke clusters in cloud environments (so far with a focus on testing
AWS). You can even configure the pools to maintain a number of spare
(hibernating) clusters, to provide rapid and cost-effective access to clusters
on-demand and at scale.</p><p>You can read more about cluster pools in the <a href=https://access.redhat.com/documentation/en-us/red_hat_advanced_cluster_management_for_kubernetes/2.6/html/multicluster_engine/multicluster_engine_overview#managing-cluster-pools>ACM documentation</a></p><p>Each managed cluster group can have multiple pools, here is an example:</p><pre tabindex=0><code>      clusterPools:
        myFirstPool:
          name: aws-ap
          openshiftVersion: 4.10.18
          baseDomain: blueprints.rhecoeng.com
          platform:
            aws:
              region: ap-southeast-2
          size: 1
          clusters:
          - tokyo
          - sydney
          - jakarta
</code></pre><p>The most important thing to change is <code>.baseDomain</code>, which will need to
correspond to a route53 domain associated with your account. We allow multiple
pools per group so that the same cluster configuration can be delivered to
multiple regions.</p><p>You can specify as many clusters as your AWS limits will support. Feel free to
choose something different than tokyo, sydney, and jakarta.</p><p>If <code>.size</code> is omitted, the pool will automatically resize based on the number of
clusters specified. Specifying no clusters will define the pool, but not
provision any clusters.</p><p><a href=https://youtu.be/FaomChtlUE4><img src=https://img.youtube.com/vi/FaomChtlUE4/default.jpg alt="Defining and scaling the cluster pool" title="Defining and scaling the cluster pool"></a></p><p><a href=https://youtu.be/M-BJrEeoNd4><img src=https://img.youtube.com/vi/M-BJrEeoNd4/default.jpg alt="Defining clusters" title="Defining clusters"></a></p><h2 id=delivering-applications-and-configuration-to-clusters>Delivering Applications and Configuration to Clusters</h2><p><a href=https://youtu.be/emn_Coqp5jQ><img src=https://img.youtube.com/vi/emn_Coqp5jQ/default.jpg alt="Updating the managed cluster configuration" title="Updating the managed cluster configuration"></a></p><h2 id=deprovisioning-clusters>Deprovisioning Clusters</h2><p><a href=https://youtu.be/F_-sne3U5ew><img src=https://img.youtube.com/vi/F_-sne3U5ew/default.jpg alt="Deprovisioning clusters" title="Deprovisioning clusters"></a></p><h2 id=conclusion>Conclusion</h2><p>Once entrusted with your cloud credentials, all patterns can drive the creation and
subsequent configuration of complex cluster topologies (including hub-of-hubs!).</p></div></div></div><div class="pf-l-grid__item pf-m-4-col"><nav class="pf-c-jump-links pf-m-vertical" aria-label=Contents><div class=pf-c-jump-links__main><div class=pf-c-jump-links__header><div class=pf-c-jump-links__label><h1>Table of Contents</h1></div></div><nav id=TableOfContents><ul class=pf-c-jump-links__list><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#multi-cluster-gitops-with-provisioning>Multi-cluster GitOps with Provisioning</a><ul class=pf-c-jump-links__list><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#introduction>Introduction</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#preparation>Preparation</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#define-a-managed-cluster-group>Define a Managed Cluster Group</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#create-a-cluster-pool>Create a Cluster Pool</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#delivering-applications-and-configuration-to-clusters>Delivering Applications and Configuration to Clusters</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#deprovisioning-clusters>Deprovisioning Clusters</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#conclusion>Conclusion</a></li></ul></li></ul></nav></div></nav></div></div></section></main></div><div><div style=padding:10px;text-align:center;color:#d2d2d2;background-color:#000>Copyright &copy; 2022 Red Hat, Inc.</div></div></body></html>